import{j as n,g as k}from"./utils.cba2a83f.js";import{r as d}from"./index.7050ffa8.js";import{B as _}from"./button.106a523c.js";import{A as j,a as P,b as v,c as T,d as S,e as A,f as g}from"./alert-dialog.254035c4.js";import"./index.9370a71d.js";import"./index.7ef91352.js";import"./index.5fb5c8e9.js";import"./index.1f3fba3a.js";import"./index.3dde182b.js";import"./index.7f78662f.js";import"./index.8f609134.js";import"./index.e2f97c53.js";import"./index.eb6f9136.js";import"./index.7dd184f8.js";const l={invalid_token:"La sesión ha expirado. Por favor, inicia el proceso de pago nuevamente.",token_expired:"La sesión ha expirado. Por favor, inicia el proceso de pago nuevamente.",unauthorized:"No tienes permiso para realizar esta operación. Verifica tus credenciales.",not_found:"No se encontró la transacción solicitada.",invalid_request:"La solicitud de pago es inválida. Verifica los datos ingresados.",insufficient_funds:"Fondos insuficientes para realizar la operación.",invalid_amount:"El monto del pago es inválido.",duplicate_transaction:"Ya existe una transacción con este identificador.",service_unavailable:"El servicio de EnZona no está disponible en este momento. Intenta más tarde.",network_error:"Error de conexión con EnZona. Verifica tu conexión a internet.",default:"Error al procesar el pago. Por favor, intenta nuevamente."};class R{credentials;accessToken=null;tokenExpiry=null;tokenRetryCount=0;MAX_TOKEN_RETRIES=3;constructor(e){this.credentials=e}formatErrorMessage(e){return e?e.error_code?l[e.error_code]||e.error_description||l.default:e.message&&e.message.includes("fetch")?l.network_error:e.message||l.default:l.default}logError(e,r,t){console.error(`[EnzonaService] Error en ${e}:`,{message:r.message||"Error desconocido",status:r.status,responseData:r.responseData,additionalInfo:t,timestamp:new Date().toISOString()})}async getAccessToken(){if(this.accessToken&&this.tokenExpiry&&this.tokenExpiry>new Date)return this.accessToken;try{const e=btoa(`${this.credentials.consumerKey}:${this.credentials.consumerSecret}`),r=await fetch(`${this.credentials.apiBaseUrl}/token`,{method:"POST",headers:{Authorization:`Basic ${e}`,"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=client_credentials"});if(!r.ok){let o;try{o=await r.json()}catch{o={error:r.statusText}}throw this.logError("getAccessToken",{status:r.status,responseData:o,message:"Error obteniendo token de acceso"}),new Error(`Error de autenticación con EnZona: ${this.formatErrorMessage(o)}`)}const t=await r.json();if(this.accessToken=t.access_token,this.tokenExpiry=new Date(Date.now()+(t.expires_in-300)*1e3),this.tokenRetryCount=0,!this.accessToken)throw new Error("No se pudo obtener token de acceso");return this.accessToken}catch(e){if(this.tokenRetryCount++,this.tokenRetryCount<this.MAX_TOKEN_RETRIES)return console.warn(`Reintentando obtener token (intento ${this.tokenRetryCount} de ${this.MAX_TOKEN_RETRIES})`),this.getAccessToken();throw e}}async handleErrorResponse(e,r){let t;try{t=await e.json()}catch{t={error:e.statusText}}throw this.logError(r,{status:e.status,responseData:t,message:`Error en ${r}`}),new Error(`Error de EnZona en ${r}: ${this.formatErrorMessage(t)}`)}async createPayment(e){try{const r=await this.getAccessToken(),t=await fetch(`${this.credentials.apiBaseUrl}/payments`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({amount:{total:e.amount.toString(),currency:e.currency},description:e.description,return_url:e.returnUrl,cancel_url:e.cancelUrl,merchant_op_id:e.merchantOpId,customer_id:e.customerId,invoice_number:e.invoiceNumber})});if(!t.ok)return this.handleErrorResponse(t,"createPayment");const o=await t.json();if(!o.transaction_uuid||!o.links||!o.links.find(s=>s.rel==="confirm"))throw new Error("Respuesta incompleta de EnZona: Falta información para continuar el pago");return{transactionUuid:o.transaction_uuid,redirectUrl:o.links.find(s=>s.rel==="confirm").href,status:o.status}}catch(r){if(r instanceof Error&&r.message.includes("token")){this.accessToken=null;try{return await this.createPayment(e)}catch(t){throw this.logError("createPayment (retry)",t,{paymentData:e}),t}}throw this.logError("createPayment",r,{paymentData:e}),r}}async checkPaymentStatus(e){try{const r=await this.getAccessToken(),t=await fetch(`${this.credentials.apiBaseUrl}/payments/${e}`,{method:"GET",headers:{Authorization:`Bearer ${r}`}});return t.ok?t.json():this.handleErrorResponse(t,"checkPaymentStatus")}catch(r){throw this.logError("checkPaymentStatus",r,{transactionUuid:e}),r}}async completePayment(e){try{const r=await this.getAccessToken(),t=await fetch(`${this.credentials.apiBaseUrl}/payments/${e}/complete`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return t.ok?t.json():this.handleErrorResponse(t,"completePayment")}catch(r){throw this.logError("completePayment",r,{transactionUuid:e}),r}}async cancelPayment(e){try{const r=await this.getAccessToken(),t=await fetch(`${this.credentials.apiBaseUrl}/payments/${e}/cancel`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return t.ok?t.json():this.handleErrorResponse(t,"cancelPayment")}catch(r){throw this.logError("cancelPayment",r,{transactionUuid:e}),r}}}const N=new R({consumerKey:{}.PUBLIC_ENZONA_CONSUMER_KEY||"",consumerSecret:{}.ENZONA_CONSUMER_SECRET||"",apiBaseUrl:{}.PUBLIC_ENZONA_API_URL||"https://api.enzona.net/payment/v1.0.0"});function $({error:i,open:e,onClose:r,tryAgain:t}){const[o,s]=d.useState(e);d.useEffect(()=>{s(e)},[e]);const h=()=>{s(!1),r()},u=()=>{s(!1),t?t():r()},m=i instanceof Error?i.message:typeof i=="string"?i:"Se produjo un error al procesar el pago";return n.jsx(j,{open:o,onOpenChange:s,children:n.jsxs(P,{children:[n.jsxs(v,{children:[n.jsx(T,{className:"text-red-600",children:"Error en el Procesamiento de Pago"}),n.jsx(S,{children:n.jsxs("div",{className:"space-y-4 py-3",children:[n.jsxs("div",{className:"flex items-start",children:[n.jsx("div",{className:"flex-shrink-0 mt-0.5",children:n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-500",viewBox:"0 0 20 20",fill:"currentColor",children:n.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),n.jsx("div",{className:"ml-3",children:n.jsx("p",{className:"text-sm text-red-500 font-medium",children:m})})]}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Por favor, intenta nuevamente o utiliza otro método de pago. Si el problema persiste, contacta con nuestro soporte técnico."}),n.jsxs("div",{className:"border-t border-gray-200 pt-4 mt-4",children:[n.jsx("h4",{className:"text-sm font-medium",children:"Posibles causas:"}),n.jsxs("ul",{className:"mt-2 text-sm text-muted-foreground list-disc pl-5 space-y-1",children:[n.jsx("li",{children:"Problemas de conexión con la pasarela de pago"}),n.jsx("li",{children:"Datos de pago incorrectos o incompletos"}),n.jsx("li",{children:"La pasarela de pago puede estar experimentando problemas técnicos"}),n.jsx("li",{children:"Tu banco puede haber rechazado la transacción"})]})]})]})})]}),n.jsxs(A,{children:[n.jsx(g,{onClick:h,children:"Cerrar"}),t&&n.jsx(g,{onClick:u,className:"bg-primary hover:bg-primary/90",children:"Intentar de nuevo"})]})]})})}function X({amount:i,description:e,businessName:r,onSuccess:t,onError:o,className:s}){const[h,u]=d.useState(!1),[m,p]=d.useState(null),[y,f]=d.useState(!1),E=async()=>{p(null);try{if(u(!0),!i||i<=0)throw new Error("El monto del pago debe ser mayor que cero");const c=k(),a=await N.createPayment({amount:i,description:`${e} - ${r}`,currency:"CUP",merchantOpId:c,returnUrl:`${window.location.origin}/payment/success?transaction_id=${c}`,cancelUrl:`${window.location.origin}/payment/cancel?transaction_id=${c}`});t&&t(a.transactionUuid),window.location.href=a.redirectUrl}catch(c){console.error("Error al procesar el pago con EnZona:",c);const a=c instanceof Error?c:new Error(typeof c=="string"?c:"Error desconocido al procesar el pago");a.message.includes("token")?a.message="Error de autenticación con la pasarela de pago. Por favor, intenta más tarde.":(a.message.includes("network")||a.message.includes("fetch"))&&(a.message="Error de conexión. Verifica tu conexión a internet e intenta nuevamente."),p(a),f(!0),o&&o(a)}finally{u(!1)}},x=()=>{E()},w=()=>{f(!1),p(null)};return n.jsxs(n.Fragment,{children:[n.jsx(_,{onClick:E,disabled:h,className:s,size:"lg",children:h?"Procesando...":"Pagar con EnZona"}),n.jsx($,{error:m,open:y,onClose:w,tryAgain:x})]})}export{X as EnzonaPaymentButton};
